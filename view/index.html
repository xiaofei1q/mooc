<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å‚²æ˜Ÿç½‘è¯¾åŠ©æ‰‹ - é…ç½®ä¸­å¿ƒ</title>
    <link rel="shortcut icon" href="https://www.aoaostar.com/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
              font-family: 'Microsoft YaHei', sans-serif;
          }
    

        body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            background-color: #f5f5f5;
        }

        .header {
            background-color: #333;
            color: #fff;
            padding: 15px 20px;
            font-size: 1.2rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .config-panel {
            width: 400px;
            background-color: #fff;
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid #ddd;
        }

        .log-panel {
            flex: 1;
            overflow-y: auto;
            background-color: #1e1e1e;
            color: #f8f8f2;
            padding: 1rem;
            word-break: break-all;
            white-space: pre-wrap;
            font-size: 1rem;
            line-height: 1.5;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .log-info {
            color: #a6e22e;
        }

        .log-error {
            color: #f92672;
        }

        .log-warning {
            color: #fd971f;
        }

        .log-timestamp {
            color: #66d9ef;
            font-weight: bold;
        }

        .progress-panel {
            width: 350px;
            overflow-y: auto;
            background-color: #fff;
            border-left: 1px solid #ddd;
            padding: 10px;
        }

        .user-progress-container {
            margin-bottom: 15px;
            padding: 10px;
            background-color: #f9f9f9;
            border-radius: 4px;
        }

        .user-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            border-bottom: 1px solid #ddd;
            padding-bottom: 5px;
        }

        .course-progress-item {
            margin-bottom: 8px;
        }

        .course-progress-bar-container {
            width: 100%;
            height: 15px;
            background-color: #f1f1f1;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 3px;
        }

        .course-progress-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .course-progress-text {
            font-size: 0.8rem;
            color: #666;
            display: flex;
            justify-content: space-between;
        }

        .completed-marker {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 3px;
            margin-left: 10px;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 2px rgba(76, 175, 80, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .btn {
            display: inline-block;
            padding: 10px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        .btn:hover {
            background-color: #45a049;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-stop {
            background-color: #f44336;
        }

        .btn-stop:hover {
            background-color: #d32f2f;
        }

        .btn-delete-completed {
            background-color: #ff9800;
        }

        .btn-delete-completed:hover {
            background-color: #e68a00;
        }

        .btn-group {
            margin-top: 20px;
        }

        .user-config {
            background-color: #ffffff;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border: 1px solid #e0e0e0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .user-config-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-config-content {
            padding: 20px;
            display: block;
        }

        .user-config-content.collapsed {
            display: none;
            padding: 0 20px;
        }

        .collapse-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            color: #666;
        }

        .user-config:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .add-user-btn {
            background-color: #2196F3;
        }

        .add-user-btn:hover {
            background-color: #0b7dda;
        }

        .user-completed-marker {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-weight: bold;
            width: 100%;
            text-align: center;
        }        

        .add-user-btn {
            margin-top: 15px;
            width: 100%;
        }

        .remove-user-btn {
            background-color: #f44336;
            margin-top: 15px;
            width: 100%;
        }

        .remove-user-btn:hover {
            background-color: #d32f2f;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-running {
            background-color: #4CAF50;
        }

        .status-stopped {
            background-color: #f44336;
        }
    </style>
</head>
<body>
    <div class="header">
    <div>å‚²æ˜Ÿç½‘è¯¾åŠ©æ‰‹ - é…ç½®ä¸­å¿ƒ</div>
    <div id="status-display">
        <span class="status-indicator status-stopped"></span>
        <span id="status-text">å·²åœæ­¢</span>
    </div>
</div>

    <div class="container">
        <div class="config-panel">
            <h3>å…¨å±€é…ç½®</h3>
            <div class="form-group">
                <label for="server">æœåŠ¡å™¨åœ°å€</label>
                <input type="text" id="server" name="server" value=":10086" placeholder=":10086">
            </div>
            <div class="form-group">
                <label for="limit">åç¨‹æ•°</label>
                <input type="number" id="limit" name="limit" value="999" min="1" max="999">
            </div>

            <div class="top-btn-group" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px;">
    <button class="btn add-user-btn" onclick="addUser()">æ·»åŠ ç”¨æˆ·</button>
    <button class="btn" onclick="saveConfig()">ä¿å­˜é…ç½®</button>
    <button class="btn" onclick="runProgram()">è¿è¡Œç¨‹åº</button>
    <button class="btn btn-stop" onclick="stopProgram()">åœæ­¢ç¨‹åº</button>
    <button class="btn btn-delete-completed" onclick="deleteCompletedUsers()">ä¸€é”®åˆ é™¤å·²å®Œæˆç”¨æˆ·</button>
</div>

<h3>ç”¨æˆ·é…ç½®</h3>
            <div id="users-container">
                <div class="user-config" data-index="0">
                    <h4>ç”¨æˆ· 1</h4>
                    <div class="form-group">
                        <label for="base_url_0">Base URL</label>
                        <input type="text" id="base_url_0" name="base_url" value="https://test-server.example.com/" placeholder="https://example.com/">
                    </div>

                    <div class="form-group">
                        <label for="username_0">ç”¨æˆ·å</label>
                        <input type="text" id="username_0" name="username" placeholder="è¾“å…¥ç”¨æˆ·å">
                    </div>
                    <div class="form-group">
                        <label for="password_0">å¯†ç </label>
                        <input type="password" id="password_0" name="password" placeholder="è¾“å…¥å¯†ç ">
                    </div>
                    <div class="form-group">
                        <label for="course_names_0">è¯¾ç¨‹åç§°ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                        <textarea id="course_names_0" name="course_names" placeholder="ä¾‹å¦‚: é«˜ç­‰æ•°å­¦,å¤§å­¦ç‰©ç†"></textarea>
                    </div>
                    <button class="btn remove-user-btn" onclick="removeUser(0)">åˆ é™¤ç”¨æˆ·</button>
                </div>
            </div>
            <!-- æŒ‰é’®å·²ç§»åŠ¨åˆ°ç”¨æˆ·é…ç½®ä¸Šæ–¹ -->
        </div>
        <div class="log-panel" id="log-panel">
            æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
        </div>
        <div class="progress-panel" id="progress-panel">
            <h3>ç”¨æˆ·è¯¾ç¨‹è¿›åº¦</h3>
            <div id="user-progress-container"></div>
        </div>
    </div>

<script>
    // ç”¨æˆ·è®¡æ•°å™¨
    let userCount = 1;
    let progressInterval;

    // æ·»åŠ ç”¨æˆ·é…ç½®è¡¨å•
    function addUser() {
        const container = document.getElementById('users-container');
        const index = userCount++;

        const userConfig = document.createElement('div');
        userConfig.className = 'user-config';
        userConfig.dataset.index = index;

        userConfig.innerHTML = `
            <div class="user-config-header" onclick="toggleUserConfig(${index})">
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    <h4>ç”¨æˆ· ${index + 1}</h4>
                    <span style="color: #666; font-size: 12px;">ID: ${index}</span>
                </div>
                <button class="collapse-btn" onclick="toggleUserConfig(${index}); event.stopPropagation();">-</button>
            </div>
            <div class="user-config-content" id="user-config-content-${index}">
                <div class="form-group">
                    <label for="base_url_${index}">Base URL</label>
                    <input type="text" id="base_url_${index}" name="base_url" value="https://test-server.example.com/" placeholder="https://example.com/">
                </div>

                <div class="form-group">
                    <label for="username_${index}">ç”¨æˆ·å</label>
                    <input type="text" id="username_${index}" name="username" placeholder="è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="form-group">
                    <label for="password_${index}">å¯†ç </label>
                    <input type="password" id="password_${index}" name="password" placeholder="è¾“å…¥å¯†ç ">
                </div>
                <div class="form-group">
                    <label for="course_names_${index}">è¯¾ç¨‹åç§°ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                    <textarea id="course_names_${index}" name="course_names" placeholder="ä¾‹å¦‚: é«˜ç­‰æ•°å­¦,å¤§å­¦ç‰©ç†"></textarea>
                </div>
                <button class="btn remove-user-btn" onclick="removeUser(${index})">åˆ é™¤ç”¨æˆ·</button>
            </div>
        `;

        // å°†æ–°ç”¨æˆ·è¡¨å•æ’å…¥åˆ°å®¹å™¨çš„ç¬¬ä¸€ä¸ªä½ç½®
        if (container.firstChild) {
            container.insertBefore(userConfig, container.firstChild);
        } else {
            container.appendChild(userConfig);
        }
    }

    // åˆ‡æ¢ç”¨æˆ·é…ç½®æŠ˜å çŠ¶æ€
    function toggleUserConfig(index) {
        const content = document.getElementById(`user-config-content-${index}`);
        const collapseBtn = document.querySelector(`.user-config[data-index="${index}"] .collapse-btn`);
        
        if (content.classList.contains('collapsed')) {
            content.classList.remove('collapsed');
            collapseBtn.textContent = '-';
        } else {
            content.classList.add('collapsed');
            collapseBtn.textContent = '+';
        }
    }

    // åˆ é™¤ç”¨æˆ·é…ç½®è¡¨å•
    function removeUser(index) {
        const container = document.getElementById('users-container');
        const userConfig = document.querySelector(`.user-config[data-index="${index}"]`);
        if (userConfig) {
            container.removeChild(userConfig);
        }
    }

    // ä¸€é”®åˆ é™¤å·²å®Œæˆæ‰€æœ‰è¯¾ç¨‹çš„ç”¨æˆ·
    function deleteCompletedUsers() {
        // æŸ¥æ‰¾æ‰€æœ‰å·²å®Œæˆç”¨æˆ·çš„é…ç½®é¡¹
        const completedUsers = document.querySelectorAll('.user-config .user-completed-marker');
        
        // å¦‚æœæ²¡æœ‰å·²å®Œæˆçš„ç”¨æˆ·ï¼Œæ˜¾ç¤ºæç¤º
        if (completedUsers.length === 0) {
            alert('æ²¡æœ‰å·²å®Œæˆæ‰€æœ‰è¯¾ç¨‹çš„ç”¨æˆ·');
            return;
        }
        
        // ç¡®è®¤æ˜¯å¦åˆ é™¤
        if (confirm(`ç¡®å®šè¦åˆ é™¤${completedUsers.length}ä¸ªå·²å®Œæˆæ‰€æœ‰è¯¾ç¨‹çš„ç”¨æˆ·å—ï¼Ÿ`)) {
            // éå†å¹¶åˆ é™¤å·²å®Œæˆç”¨æˆ·
            completedUsers.forEach(marker => {
                const userConfig = marker.closest('.user-config');
                if (userConfig) {
                    const index = userConfig.dataset.index;
                    removeUser(index);
                }
            });
            
            // ä¿å­˜é…ç½®
            saveConfig();
            
            // æ˜¾ç¤ºåˆ é™¤æˆåŠŸæç¤º
            alert(`æˆåŠŸåˆ é™¤${completedUsers.length}ä¸ªå·²å®Œæˆæ‰€æœ‰è¯¾ç¨‹çš„ç”¨æˆ·`);
        }
    }

    // ä¿å­˜é…ç½®
    function saveConfig() {
        const config = {
            global: {
                server: document.getElementById('server').value,
                limit: parseInt(document.getElementById('limit').value)
            },
            users: []
        };

        // æ”¶é›†æ‰€æœ‰ç”¨æˆ·é…ç½®
        const userConfigs = document.querySelectorAll('.user-config');
        userConfigs.forEach(userConfig => {
            const index = userConfig.dataset.index;
            const courseNames = document.getElementById(`course_names_${index}`).value
                .split(',').map(name => name.trim()).filter(name => name);

            config.users.push({
                base_url: document.getElementById(`base_url_${index}`).value,
                school_id: 0,
                username: document.getElementById(`username_${index}`).value,
                password: document.getElementById(`password_${index}`).value,
                course_names: courseNames
            });
        });

        // å‘é€é…ç½®åˆ°åç«¯
        fetch('/save-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(config)
        }).then(response => {
            if (response.ok) {
                alert('é…ç½®ä¿å­˜æˆåŠŸ!');
            } else {
                alert('é…ç½®ä¿å­˜å¤±è´¥!');
            }
        }).catch(error => {
            console.error('ä¿å­˜é…ç½®å‡ºé”™:', error);
            alert('é…ç½®ä¿å­˜å¤±è´¥!');
        });
    }

    // è¿è¡Œç¨‹åº
    function runProgram() {
        fetch('/run-program', {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                updateStatus(true);
                alert('ç¨‹åºå·²å¯åŠ¨!');
                
                // å¼€å§‹å®šæœŸè·å–è¿›åº¦
                if (progressInterval) {
                    clearInterval(progressInterval);
                }
                progressInterval = setInterval(() => {
                    updateUserCourseProgress();
                }, 1000);
            } else {
                alert('ç¨‹åºå¯åŠ¨å¤±è´¥!');
            }
        }).catch(error => {
            console.error('å¯åŠ¨ç¨‹åºå‡ºé”™:', error);
            alert('ç¨‹åºå¯åŠ¨å¤±è´¥!');
        });
    }

    // åœæ­¢ç¨‹åº
    function stopProgram() {
        fetch('/stop-program', {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                updateStatus(false);
                // æ¸…é™¤è¿›åº¦æ›´æ–°å®šæ—¶å™¨
                if (progressInterval) {
                    clearInterval(progressInterval);
                    progressInterval = null;
                }
                alert('ç¨‹åºå·²åœæ­¢!');
            } else {
                alert('ç¨‹åºåœæ­¢å¤±è´¥!');
            }
        }).catch(error => {
            console.error('åœæ­¢ç¨‹åºå‡ºé”™:', error);
            alert('ç¨‹åºåœæ­¢å¤±è´¥!');
        });
    }

    // æ›´æ–°ç”¨æˆ·è¯¾ç¨‹è¿›åº¦
    function updateUserCourseProgress() {
        fetch('/user-course-progress')
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('user-progress-container');
                container.innerHTML = '';
                
                // å®šä¹‰ä¸åŒç”¨æˆ·çš„é¢œè‰²
                const userColors = [
                    '#E0F7FA', // æµ…é’è‰²
                    '#E8F5E9', // æµ…ç»¿è‰²
                    '#FFF8E1', // æµ…é»„è‰²
                    '#F3E5F5', // æµ…ç´«è‰²
                    '#FFEBEE', // æµ…çº¢è‰²
                    '#E0E0E0', // æµ…ç°è‰²
                    '#E3F2FD', // æµ…è“è‰²
                    '#FFF3E0', // æµ…æ©™è‰²
                    '#F1F8E9', // æµ…ç»¿è‰²2
                    '#FBE9E7'  // æµ…çº¢è‰²2
                ];
                
                // è·å–æ‰€æœ‰ç”¨æˆ·IDå¹¶æ’åºï¼Œç¡®ä¿é¢œè‰²åˆ†é…ä¸€è‡´
                const userIds = Object.keys(data).sort();
                
                // éå†æ¯ä¸ªç”¨æˆ·
                userIds.forEach((userId, index) => {
                    const userProgress = data[userId];
                    
                    // é€‰æ‹©ç”¨æˆ·é¢œè‰² (å¾ªç¯ä½¿ç”¨é¢„å®šä¹‰é¢œè‰²)
                    const colorIndex = index % userColors.length;
                    const userColor = userColors[colorIndex];
                    
                    // åˆ›å»ºç”¨æˆ·è¿›åº¦å®¹å™¨
                    const userContainer = document.createElement('div');
                    userContainer.className = 'user-progress-container';
                    userContainer.style.backgroundColor = userColor;
                    userContainer.style.borderLeft = `4px solid ${getDarkerColor(userColor)}`;
                    
                    // åˆ›å»ºç”¨æˆ·æ ‡é¢˜
                    const userTitle = document.createElement('div');
                    userTitle.className = 'user-title';
                    userTitle.textContent = `ç”¨æˆ·: ${userId}`;
                    userContainer.appendChild(userTitle);
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æ‰€æœ‰è¯¾ç¨‹éƒ½å·²å®Œæˆ
                    let isUserCompleted = true;
                    for (const courseId in userProgress) {
                        if (userProgress.hasOwnProperty(courseId)) {
                            const course = userProgress[courseId];
                            if (course.Progress < 100) {
                                isUserCompleted = false;
                                break;
                            }
                        }
                    }

                    // æ›´æ–°ç”¨æˆ·é…ç½®ä¸­çš„å·²å®Œæˆæ ‡å¿—
                    const userConfig = document.querySelector(`.user-config[data-index="${index}"]`);
                    if (userConfig) {
                        // ç§»é™¤å·²å­˜åœ¨çš„å·²å®Œæˆæ ‡å¿—
                        const existingMarker = userConfig.querySelector('.user-completed-marker');
                        if (existingMarker) {
                            existingMarker.remove();
                        }

                        // å¦‚æœç”¨æˆ·æ‰€æœ‰è¯¾ç¨‹éƒ½å·²å®Œæˆï¼Œæ·»åŠ å·²å®Œæˆæ ‡å¿—
                        if (isUserCompleted) {
                            const completedMarker = document.createElement('div');
                            completedMarker.className = 'user-completed-marker';
                            completedMarker.textContent = 'ç”¨æˆ·å·²å®Œæˆæ‰€æœ‰è¯¾ç¨‹';

                            // æ‰¾åˆ°åˆ é™¤ç”¨æˆ·æŒ‰é’®ï¼Œå¹¶åœ¨å…¶ä¸‹æ–¹æ·»åŠ æ ‡å¿—
                            const removeBtn = userConfig.querySelector('.remove-user-btn');
                            if (removeBtn) {
                                removeBtn.parentNode.appendChild(completedMarker);
                            }
                        }
                    }

                    // éå†ç”¨æˆ·çš„æ¯ä¸ªè¯¾ç¨‹
                        for (const courseId in userProgress) {
                            if (userProgress.hasOwnProperty(courseId)) {
                                const course = userProgress[courseId];
                                
                                // åˆ›å»ºè¯¾ç¨‹è¿›åº¦é¡¹
                                const courseItem = document.createElement('div');
                                courseItem.className = 'course-progress-item';
                                
                                // åˆ›å»ºè¯¾ç¨‹è¿›åº¦æ–‡æœ¬
                                const courseText = document.createElement('div');
                                courseText.className = 'course-progress-text';
                                courseText.innerHTML = `
                                    <span>${course.CourseName}</span>
                                    <span>${Math.round(course.Progress)}% (${course.Status})</span>
                                `;
                                courseItem.appendChild(courseText);
                                
                                // åˆ›å»ºè¯¾ç¨‹è¿›åº¦æ¡å®¹å™¨
                                const progressBarContainer = document.createElement('div');
                                progressBarContainer.className = 'course-progress-bar-container';
                                
                                // åˆ›å»ºè¯¾ç¨‹è¿›åº¦æ¡
                                const progressBar = document.createElement('div');
                                progressBar.className = 'course-progress-bar';
                                
                                // æ ¹æ®è¿›åº¦è®¾ç½®é¢œè‰²
                                if (course.Progress === 100) {
                                    progressBar.style.backgroundColor = '#4CAF50'; // ç»¿è‰²
                                    // æ·»åŠ å·²å®Œæˆæ ‡è®°
                                    const completedMarker = document.createElement('div');
                                    completedMarker.className = 'completed-marker';
                                    completedMarker.textContent = 'å·²å®Œæˆ';
                                    courseItem.appendChild(completedMarker);
                                } else if (course.Status === 'failed') {
                                    progressBar.style.backgroundColor = '#f44336'; // çº¢è‰²
                                } else if (course.Status === 'in_progress') {
                                    progressBar.style.backgroundColor = '#2196F3'; // è“è‰²
                                } else {
                                    progressBar.style.backgroundColor = '#ff9800'; // æ©™è‰²
                                }
                                
                                progressBar.style.width = `${course.Progress}%`;
                                progressBarContainer.appendChild(progressBar);
                                courseItem.appendChild(progressBarContainer);
                                
                                userContainer.appendChild(courseItem);
                            }
                        }
                        
                        container.appendChild(userContainer);
                });
            })
            .catch(error => {
                console.error('è·å–ç”¨æˆ·è¯¾ç¨‹è¿›åº¦å¤±è´¥:', error);
            });
    }

    // è·å–é¢œè‰²çš„æ·±è‰²è°ƒ
    function getDarkerColor(color) {
        // ç®€å•çš„é¢œè‰²åŠ æ·±å‡½æ•°
        // ç§»é™¤#å·
        color = color.replace('#', '');
        
        // è½¬æ¢ä¸ºRGB
        let r = parseInt(color.substring(0, 2), 16);
        let g = parseInt(color.substring(2, 4), 16);
        let b = parseInt(color.substring(4, 6), 16);
        
        // é™ä½äº®åº¦ (ä¹˜ä»¥0.7)
        r = Math.floor(r * 0.7);
        g = Math.floor(g * 0.7);
        b = Math.floor(b * 0.7);
        
        // è½¬æ¢å›åå…­è¿›åˆ¶
        const toHex = (c) => {
            const hex = c.toString(16);
            return hex.length === 1 ? '0' + hex : hex;
        };
        
        return '#' + toHex(r) + toHex(g) + toHex(b);
    }
        
    

    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    function updateStatus(isRunning) {
        const indicator = document.querySelector('.status-indicator');
        const text = document.getElementById('status-text');

        if (isRunning) {
            indicator.className = 'status-indicator status-running';
            text.textContent = 'è¿è¡Œä¸­';
        } else {
            indicator.className = 'status-indicator status-stopped';
            text.textContent = 'å·²åœæ­¢';
        }
    }

    // å®šä¹‰è´¦å·é¢œè‰²æ˜ å°„
    const userIdColors = {};
    const availableColors = [
        '#4CAF50', // ç»¿è‰²
        '#2196F3', // è“è‰²
        '#FF9800', // æ©™è‰²
        '#9C27B0', // ç´«è‰²
        '#F44336', // çº¢è‰²
        '#00BCD4', // é’è‰²
        '#FFC107', // é»„è‰²
        '#795548', // æ£•è‰²
        '#607D8B', // è“ç°è‰²
        '#3F51B5'  // é›è“è‰²
    ];
    let colorIndex = 0;
    
    // è·å–è´¦å·é¢œè‰²
    function getUserIdColor(userId) {
        if (!userIdColors[userId]) {
            userIdColors[userId] = availableColors[colorIndex % availableColors.length];
            colorIndex++;
        }
        return userIdColors[userId];
    }
    
    // å®æ—¶æ›´æ–°æ—¥å¿—
    function updateLog() {
        fetch('/ajax').then(async resp => {
            const logPanel = document.getElementById('log-panel');
            let logText = await resp.text();
            
            // ç§»é™¤ANSIè½¬ä¹‰åºåˆ—å’Œç‰¹æ®Šå­—ç¬¦
            logText = logText
                // ç§»é™¤ANSIè½¬ä¹‰åºåˆ— (å¦‚: \x1B[32m)
                .replace(/\x1B\[[0-9;]*m/g, '')
                // ç§»é™¤ç‰¹æ®Šå­—ç¬¦ ''
                .replace(/\x1B/g, '')
                // ä¸ºæ—¶é—´æˆ³æ·»åŠ æ ·å¼
                .replace(/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/g, '<span class="log-timestamp">[$1]</span>')
                // ä¸ºè´¦å·IDæ·»åŠ é¢œè‰²æ ·å¼
                .replace(/\[(\d+)\]/g, (match, userId) => {
                    const color = getUserIdColor(userId);
                    return `<span style="color: ${color};">[${userId}]</span>`;
                })
                // ä¸ºåç¨‹IDä¸­çš„è´¦å·æ·»åŠ é¢œè‰²æ ·å¼
                .replace(/\[åç¨‹ID=\d+\]\[(\d+)\]/g, (match, userId) => {
                    const color = getUserIdColor(userId);
                    return match.replace(`[${userId}]`, `<span style="color: ${color};">[${userId}]</span>`);
                })
                // ä¸ºä¿¡æ¯æ—¥å¿—æ·»åŠ æ ·å¼
                .replace(/\[info\]/g, '<span class="log-info">[info]</span>')
                // ä¸ºé”™è¯¯æ—¥å¿—æ·»åŠ æ ·å¼
                .replace(/\[error\]/g, '<span class="log-error">[error]</span>')
                // ä¸ºè­¦å‘Šæ—¥å¿—æ·»åŠ æ ·å¼
                .replace(/\[warn\]/g, '<span class="log-warning">[warn]</span>')
                // ä¸ºæˆåŠŸæ—¥å¿—æ·»åŠ æ ·å¼
                .replace(/\[success\]/g, '<span class="log-info">[success]</span>');
            
            logPanel.innerHTML = logText;
            logPanel.scrollTop = logPanel.scrollHeight;
        }).finally(() => {
            setTimeout(updateLog, 1000);
        });
    }

    // æ£€æŸ¥ç¨‹åºçŠ¶æ€
    function checkStatus() {
        fetch('/program-status').then(async resp => {
            const status = await resp.json();
            updateStatus(status.isRunning);
        }).finally(() => {
            setTimeout(checkStatus, 2000);
        });
    }

    // åŠ è½½é…ç½®
    function loadConfig() {
        fetch('/get-config')
            .then(response => response.json())
            .then(config => {
                // å¡«å……å…¨å±€é…ç½®
                document.getElementById('server').value = config.global.server;
                document.getElementById('limit').value = config.global.limit;
                
                // æ¸…ç©ºç°æœ‰ç”¨æˆ·é…ç½®
                const usersContainer = document.getElementById('users-container');
                usersContainer.innerHTML = '';
                userCount = 0;
                
                // å¡«å……ç”¨æˆ·é…ç½®
                config.users.forEach((user, index) => {
                    addUser();
                    
                    // è®¾ç½®ç”¨æˆ·é…ç½®å€¼
                    document.getElementById(`base_url_${index}`).value = user.base_url || 'https://test-server.example.com/';

                    document.getElementById(`username_${index}`).value = user.username || '';
                    document.getElementById(`password_${index}`).value = user.password || '';
                    document.getElementById(`course_names_${index}`).value = user.course_names ? user.course_names.join(', ') : '';
                });
            })
            .catch(error => {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
            });
    }

    // åˆå§‹åŒ–
    updateLog();
    checkStatus();
    loadConfig();
</script>
</body>
</html>